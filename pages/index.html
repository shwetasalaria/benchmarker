<!--
.. title: Stats
.. date: 2018-06-02 09:39:34 UTC
.. tags:
.. category:
.. link:
.. type: text
.. hidetitle: True
.. author: 
.. template: charts.tmpl
.. has_math: yes
-->

<section class="container">
<h1>FP32 precision training</h1>
<h3>[still debugging, expect more content soon]</h3>
<div id="div_debug"> </div>

{{% generate_controls %}}
      <script type="text/javascript">
        function set_filter(key, val) {
          if ( (key != prim_key) && (key != sec_key))
          filters[key] = val;
          plot_chart(); };
        function set_key_filter(key, val, id)
        {
        if (document.getElementById(id).checked)  {
          filters_prim[key].add(val);
          }
        else {
          filters_prim[key].delete(val);
        }
          plot_chart();
        }  

        function set_prim_key(key) {
          if (sec_key == key)
            sec_key = prim_key;
          prim_key = key;
          if (filters.hasOwnProperty(key))  {           
              delete filters[key] }
          plot_chart(); };
        function set_sec_key(key) {
          if (prim_key == key)
            prim_key = sec_key; 
          sec_key = key;
          if (filters.hasOwnProperty(key))  {           
              delete filters[key] }
          plot_chart();  };
        function display_filters() {
          document.getElementById("radio_key1_" + prim_key).checked=true;
          document.getElementById("radio_key2_" + sec_key).checked=true;
          //document.getElementById("div_prim_key").innerHTML = prim_key;
          //document.getElementById("div_sec_key").innerHTML = sec_key;
          $("#div_radio_" + prim_key).hide('fast')
          $("#div_check_" + prim_key).show('fast')
          $("#div_radio_" + sec_key).hide('fast')
          $("#div_check_" + sec_key).show('fast')
          for (key in keyvals) {
              //str_filters += key +": "+filters[key];
              if ((key != prim_key) && (key != sec_key))
              {
                $("#div_radio_" + key).show('fast')
                $("#div_check_" + key).hide('fast')
                if (! filters.hasOwnProperty(key))
                  filters[key] = keyvals[key][0]
              }
          }  
          for (key in filters) {
            document.getElementById("radio_" + key + "_" + filters[key]).checked=true;
          }
        }
      </script>

<canvas id="myChart" width="800" height="450"></canvas>

<script>
function apply_filters(df, filters)
{
  res = df
  for (var key in filters) 
  {
    if (filters.hasOwnProperty(key)) 
      res = res.where(row => row[key] == filters[key]);
  }
  return res
}

function get_value(df, key, val)
{
  var filtered = df.where(row => row[key] == val)
  var cols = filtered.getColumns().where(column => column.name == "perf").first().series
  return cols.average()
}

function get_rec_per_sec_key(df, sec_key, sec_val, prim_key, prim_values, id_color)
{
  var result = {}
  result["label"] = sec_val
  result["backgroundColor"] = colors[id_color]
  var filtered_df = df.where(row => row[sec_key] == sec_val);
  result["data"] = prim_values.map(k => get_value(filtered_df, prim_key, k))
  return result
}

function get_chart_data()
{
  var prim_values = df.getColumns().where(column => column.name == prim_key).first().series.distinct().toArray();
  var sec_values = df.getColumns().where(column => column.name == sec_key).first().series.distinct().toArray();
  prim_values = prim_values.filter(k => filters_prim[prim_key].has(k));
  sec_values = sec_values.filter(k => filters_prim[sec_key].has(k));
  df_filtered = apply_filters(df, filters)
  var chart_data = {
    labels: prim_values,
    datasets: sec_values.map((k,i) => get_rec_per_sec_key(df_filtered, sec_key, k, prim_key, prim_values, i))
  };
  return chart_data
}
</script>

<script>
function plot_chart()
{
display_filters();
var ctx = document.getElementById("myChart").getContext("2d");
var color = Chart.helpers.color;

var myBarChart = new Chart(ctx, {
    type: 'bar',
    data: get_chart_data(),
    options: {
        barValueSpacing: 20,
        scales: {
            yAxes: 
            [
            {
                ticks: 
                {
                    min: 0,
                },
                scaleLabel: 
                {
                    display: true,
                    labelString: 'samples per second'
                }            
            }
            ]
        }
    }
});

}

</script>
</section>
